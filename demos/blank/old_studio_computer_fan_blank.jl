### A Pluto.jl notebook ###
# v0.19.22

using Markdown
using InteractiveUtils

# â•”â•â•¡ fdb809e2-8529-11ec-2cce-db853e9d397a
begin
    import Pkg; Pkg.activate();
    using Controlz, CairoMakie
end

# â•”â•â•¡ 22cdde6c-9880-4eae-a5dd-35435ea539b5
set_theme!(Controlz.cool_theme)

# â•”â•â•¡ df9ee53f-a59a-4496-9fe2-89f688bd13b7
md"## simulating GPU cooling via a fan

![](https://raw.githubusercontent.com/SimonEnsemble/CHE_361_W2023/main/images/GPU_cooling_fan.png)

## dynamic model
variables:
*  $\theta_a(t)$: air temperature [input]
*  $q(t)$: heat generated by GPU during its computation [input]
*  $\theta(t)$: temperature of the GPU [output]

let $\bar{\theta_a}$, $\bar{q}$, and $\bar{\theta}$ be the steady-state value values of the variables

the dynamic model is
```math
	C\frac{d\theta}{dt} = q + UA[\theta_a-\theta]
```
with parameters:
*  $C$: thermal mass of GPU
*  $U$: heat transfer coefficient
*  $A$: area for GPU-air heat transfer
"

# â•”â•â•¡ e6319424-717d-4a6e-9c89-191f9cf5f755
md"### goal

the goal is to simulate the response of the output $\theta(t)$ to an input change in $\theta_a(t)$ using `Controlz.jl`.


!!! note \"Controlz.jl\"
	see [here](https://simonensemble.github.io/Controlz.jl/dev/) for the `Controlz` docs. 
	* a high-level overview of how to simulate the response of an LTI system [here](https://simonensemble.github.io/Controlz.jl/dev/).
	* construct transfer functions [here](https://simonensemble.github.io/Controlz.jl/dev/tfs/)
	* run a simulation and access the output data [here](https://simonensemble.github.io/Controlz.jl/dev/sim/)
	* draw visualizations (see `viz_response`)---or just draw your own plot via `CairoMakie`. [here](https://simonensemble.github.io/Controlz.jl/dev/viz/)

the parameters of the system are given below.
"

# â•”â•â•¡ cce81538-089d-4bc4-a01b-6da32f8da3b6
begin
	# thermal mass of GPU
	C  = 0.7 * 100 # J / Â°C
	# heat transfer coefficient
	U  = 300.0     # J / (mÂ²-s-Â°C)
	# area across which heat transfer occurs
	A  = 0.01      # mÂ²
end

# â•”â•â•¡ 98590246-3f96-4429-9d87-11d9ad328a41
Ï„ = C / (U * A) # s

# â•”â•â•¡ d45e1573-acfb-40ca-bd38-2f2029ca718d
K = 1 # Â°C / Â°C

# â•”â•â•¡ 9756f9b0-5362-45c9-8d60-9f5a24303eef
md"ğŸ‘½ suppose the steady-state heat generation $\bar{q}=100$ J/s and steady-state air temperature $\bar{\theta_a}=25$ Â°C. calcluate the steady-state value of the GPU temperature, $\bar{\theta}$ Â°C.
"

# â•”â•â•¡ 3dd2ac71-7ff8-4e14-94d0-4a2ddd6ae665
begin
	Î¸Ì„â‚ = 25.0 # Â°C
	qÌ„ = 100.0 # J/s
	Î¸Ì„ = Î¸Ì„â‚ + qÌ„ / (U * A) # Â°C
end

# â•”â•â•¡ 8e4a0330-5692-42a2-a87f-c1eaeb05504f
md"
## the input we consider

suppose:
* the heat generation is fixed at its steady state value, so $q(t)=\bar{q} \; \forall t$.
* the air temperature is and has been at its steady state value (indoor air temperature $\bar{\theta_a}$) until $t=0$, when the computer is suddenly taken outdoors and kept there. as a result, the air temperature suddenly increases by $\Delta \theta_a$ from moving the computer from indoors to outdoors. this is a step input:
```math
\begin{equation}
	\theta_a(t) = \begin{cases} 
\bar{\theta_a} & t\leq 0\\
\bar{\theta_a} +\Delta \theta_a & t>0
\end{cases}
\end{equation}
```

ğŸ‘½ given the value of $\Delta \theta_a$ defined below, define the input $\Theta_a^*(s):=\mathcal{L}[\theta_a^*(t)]$ below.
"

# â•”â•â•¡ 858312af-b838-4207-a5da-fd63cdf85c88
Î”Î¸â‚ = 10.0 # Â°C

# â•”â•â•¡ 7f58cf2e-b758-470c-a013-4b29ea6e4557
Î˜â‚â˜… = Î”Î¸â‚ / s

# â•”â•â•¡ c3fab225-dff5-42b6-b81c-1116e00d65f1
md"ğŸ‘½construct the transfer function $G(s)$."

# â•”â•â•¡ e353b680-99a2-482f-9c4a-6b03cd351c3d
G = K / (Ï„ * s + 1)

# â•”â•â•¡ c12bc46b-5ae6-42dc-8fac-d8bf4346b393
md"ğŸ‘½ through transfer function multiplication, construct the output $\Theta^*(s):=\mathcal{L}[\theta(s)]$."

# â•”â•â•¡ 0bc3f13f-5700-47dd-9497-f7ee19051710
Î˜â˜… = G * Î˜â‚â˜…

# â•”â•â•¡ 16a727f0-fc30-4f3d-a768-d23d8863eae9
md"ğŸ‘½ simulate the output $\theta^*(t)$ from $t\in[0,180]$ s using `simulate` in `Controlz`."

# â•”â•â•¡ f5b1d37f-323a-4e72-b18e-70a26356970b
data = simulate(Î˜â˜…, 180.0)

# â•”â•â•¡ 6390d313-8b8e-4a4b-8e86-5d822b319629
data[:, "t"]

# â•”â•â•¡ ea4b77db-d727-4df9-bea6-e5e4c8fe6874
data[:, "output"]

# â•”â•â•¡ 9af3682e-d0c7-4f90-ae0e-dc0310ff5ed9
md"ğŸ‘½visualize the response $\theta(t)$ (note: not in deviation form). label your axes and include units."

# â•”â•â•¡ e54122be-cfc4-4e2a-aa55-8e093202e9a5
begin
	fig = Figure()
	ax  = Axis(fig[1, 1], xlabel="time, t [s]", ylabel="GPU temp. Î¸ [Â°C]")
	lines!(data[:, "t"], Î¸Ì„ .+ data[:, "output"], color="green")
	fig
end

# â•”â•â•¡ 17f856a4-d969-46a0-8c64-2c2a410633e0
md"ğŸ‘½what is the GPU temperature at the end of the simulation?"

# â•”â•â•¡ fb505633-ac01-4864-85ce-b0ea9b19271f
Î¸Ì„_new = Î¸Ì„ + data[end, "output"]

# â•”â•â•¡ c29a0c44-60b2-4530-b0fa-3158d35768d1
md"ğŸ‘½ at what time does the GPU first reach 66 Â°C?

!!! hint
	one way is to use `findfirst`.
"

# â•”â•â•¡ ace290ca-ca01-4148-bd34-ac2310ff328c
t_special = data[findfirst(data[:, "output"] .+ Î¸Ì„ .> 66.0), "t"]

# â•”â•â•¡ f646f433-c040-4950-9fbb-b28389781fa2
for i = 1:100
	if data[i, "output"] + Î¸Ì„ > 66.0
		println("t = ", data[i, "t"], " s")
		break
	end
end

# â•”â•â•¡ f724dfc7-f179-4a58-aeeb-e74ee6c6a289
begin
	hlines!(ax, Î¸Ì„_new, color="orange", linestyle="--", linewidth=1)
	vlines!(ax, t_special, color="orange", linestyle="--", linewidth=1)
	fig
end

# â•”â•â•¡ Cell order:
# â• â•fdb809e2-8529-11ec-2cce-db853e9d397a
# â• â•22cdde6c-9880-4eae-a5dd-35435ea539b5
# â•Ÿâ”€df9ee53f-a59a-4496-9fe2-89f688bd13b7
# â•Ÿâ”€e6319424-717d-4a6e-9c89-191f9cf5f755
# â• â•cce81538-089d-4bc4-a01b-6da32f8da3b6
# â• â•98590246-3f96-4429-9d87-11d9ad328a41
# â• â•d45e1573-acfb-40ca-bd38-2f2029ca718d
# â•Ÿâ”€9756f9b0-5362-45c9-8d60-9f5a24303eef
# â• â•3dd2ac71-7ff8-4e14-94d0-4a2ddd6ae665
# â•Ÿâ”€8e4a0330-5692-42a2-a87f-c1eaeb05504f
# â• â•858312af-b838-4207-a5da-fd63cdf85c88
# â• â•7f58cf2e-b758-470c-a013-4b29ea6e4557
# â•Ÿâ”€c3fab225-dff5-42b6-b81c-1116e00d65f1
# â• â•e353b680-99a2-482f-9c4a-6b03cd351c3d
# â•Ÿâ”€c12bc46b-5ae6-42dc-8fac-d8bf4346b393
# â• â•0bc3f13f-5700-47dd-9497-f7ee19051710
# â•Ÿâ”€16a727f0-fc30-4f3d-a768-d23d8863eae9
# â• â•f5b1d37f-323a-4e72-b18e-70a26356970b
# â• â•6390d313-8b8e-4a4b-8e86-5d822b319629
# â• â•ea4b77db-d727-4df9-bea6-e5e4c8fe6874
# â•Ÿâ”€9af3682e-d0c7-4f90-ae0e-dc0310ff5ed9
# â• â•e54122be-cfc4-4e2a-aa55-8e093202e9a5
# â•Ÿâ”€17f856a4-d969-46a0-8c64-2c2a410633e0
# â• â•fb505633-ac01-4864-85ce-b0ea9b19271f
# â•Ÿâ”€c29a0c44-60b2-4530-b0fa-3158d35768d1
# â• â•ace290ca-ca01-4148-bd34-ac2310ff328c
# â• â•f646f433-c040-4950-9fbb-b28389781fa2
# â• â•f724dfc7-f179-4a58-aeeb-e74ee6c6a289
